<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integrado Honda - Recreio Motos</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#dc2626">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- ESTILOS VISUAIS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 30%, #fff5f5 70%, #ffffff 100%);
            min-height: 100vh; overflow-x: hidden;
        }
        /* Fundo */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(circle at 20% 50%, rgba(220, 38, 38, 0.08) 0%, transparent 50%);
            pointer-events: none; z-index: -1;
        }
        
        /* Navbar */
        .navbar {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(220, 38, 38, 0.15); padding: 15px 40px;
            position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center;
        }
        .logo-section { display: flex; align-items: center; gap: 15px; }
        .logo-icon { width: 45px; height: 45px; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); border-radius: 12px; display: flex; justify-content: center; align-items: center; }
        .logo-icon img { width: 120%; border-radius: 50%; }
        .brand-text h1 { color: #1a1a1a; font-size: 1.4em; font-weight: 700; }
        .brand-text p { color: #666; font-size: 0.8em; }

        .nav-buttons { display: flex; gap: 10px; }
        button { cursor: pointer; border: none; font-family: inherit; }
        .action-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; display: flex; gap: 6px; align-items: center; }
        .backup-btn { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
        .backup-btn:hover { background: #e5e7eb; color: #1f2937; }
        .add-system-btn { background: #10b981; color: white; padding: 10px 20px; border-radius: 10px; }
        .back-btn { background: #dc2626; color: white; padding: 10px 20px; border-radius: 10px; display: none; }

        /* Grid e Cards */
        .main-content { max-width: 1400px; margin: 40px auto; padding: 0 40px; }
        .systems-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .system-card { background: white; border: 1px solid rgba(220, 38, 38, 0.1); border-radius: 20px; padding: 30px; transition: 0.3s; cursor: pointer; }
        .system-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .card-icon { font-size: 40px; }
        .delete-btn { background: #fee2e2; color: #dc2626; padding: 5px 10px; border-radius: 6px; font-weight: bold; }

        /* Fullscreen */
        .fullscreen-mode { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 5000; background: #f8f9fa; padding: 0 !important; margin: 0 !important; }
        .fullscreen-mode #sys-iframe { height: 100% !important; border: none !important; }
        .fullscreen-mode .system-header-controls { position: absolute; top: 10px; right: 20px; z-index: 5001; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 12px; }

        /* Modais */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 5vh auto; padding: 30px; border-radius: 20px; width: 90%; max-width: 600px; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; }
        .upload-area { border: 2px dashed #e5e7eb; padding: 30px; text-align: center; border-radius: 12px; cursor: pointer; }
        .upload-area.has-file { border-color: #10b981; background: #ecfdf5; }
        
        .icon-selector { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .icon-option { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border: 2px solid #eee; border-radius: 8px; cursor: pointer; font-size: 20px; }
        .icon-option.selected { border-color: #dc2626; background: #fff5f5; }

        .btn-primary { background: #dc2626; color: white; padding: 10px 20px; border-radius: 8px; }
        .btn-secondary { background: #f3f4f6; color: #333; padding: 10px 20px; border-radius: 8px; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        /* Notifica√ß√£o */
        .notification { position: fixed; bottom: 30px; right: 30px; padding: 15px 25px; background: #10b981; color: white; border-radius: 10px; transform: translateY(150px); transition: 0.3s; z-index: 6000; }
        .notification.show { transform: translateY(0); }
        .notification.error { background: #dc2626; }
        .notification.info { background: #2563eb; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo-section">
            <div class="logo-icon"><img src="https://logodownload.org/wp-content/uploads/2014/04/honda-motos-logo-01.png"></div>
            <div class="brand-text"><h1>Recreio Motos</h1><p>Sistema Integrado de Gest√£o</p></div>
        </div>
        <div class="nav-buttons">
            <button class="action-btn backup-btn" onclick="syncDownload()">‚òÅÔ∏è‚¨áÔ∏è Restaurar Nuvem</button>
            <button class="action-btn backup-btn" onclick="openSyncModal()">‚òÅÔ∏è‚¨ÜÔ∏è Backup Nuvem</button>
            <button class="action-btn backup-btn" onclick="exportData()">‚¨á Local</button>
            <button class="action-btn backup-btn" onclick="document.getElementById('importFile').click()">‚¨Ü Local</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
            
            <button class="add-system-btn" id="addSystemBtn">+ Adicionar</button>
            <button class="back-btn" id="backBtn">‚Üê Voltar</button>
        </div>
    </nav>

    <main class="main-content">
        <div id="loading" style="text-align:center; padding: 50px; color: #666;">Carregando sistemas...</div>
        
        <div class="home-view" id="homeView" style="display:none">
            <div class="systems-grid" id="systemsGrid"></div>
        </div>

        <div class="system-view" id="systemView" style="display:none">
            <div id="systemContent" style="height: calc(100vh - 140px);"></div>
        </div>
    </main>

    <div id="addSystemModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Novo Sistema</h2>
            <form id="addSystemForm">
                <input type="text" class="form-control" id="systemName" required placeholder="Nome do Sistema">
                <textarea class="form-control" id="systemDescription" required placeholder="Descri√ß√£o"></textarea>
                
                <div class="icon-selector" id="iconSelector">
                    <div class="icon-option" data-icon="üìä" title="Relat√≥rios">üìä</div>
                    <div class="icon-option" data-icon="üìà" title="Vendas">üìà</div>
                    <div class="icon-option" data-icon="üìã" title="Checklist">üìã</div>
                    <div class="icon-option" data-icon="üèçÔ∏è" title="Motos">üèçÔ∏è</div>
                    <div class="icon-option" data-icon="üîß" title="Oficina">üîß</div>
                    <div class="icon-option" data-icon="‚öôÔ∏è" title="Pe√ßas">‚öôÔ∏è</div>
                    <div class="icon-option" data-icon="üõû" title="Pneus">üõû</div>
                    <div class="icon-option" data-icon="üí∞" title="Financeiro">üí∞</div>
                    <div class="icon-option" data-icon="üí≥" title="Pagamentos">üí≥</div>
                    <div class="icon-option" data-icon="üè¶" title="Banco/Financiamento">üè¶</div>
                    <div class="icon-option" data-icon="üì¶" title="Estoque">üì¶</div>
                    <div class="icon-option" data-icon="üöö" title="Entrega">üöö</div>
                    <div class="icon-option" data-icon="üìç" title="Rastreamento">üìç</div>
                    <div class="icon-option" data-icon="üë•" title="Clientes">üë•</div>
                    <div class="icon-option" data-icon="ü§ù" title="Vendas/Parcerias">ü§ù</div>
                    <div class="icon-option" data-icon="üìÖ" title="Agendamento">üìÖ</div>
                    <div class="icon-option" data-icon="üìù" title="Contratos">üìù</div>
                    <div class="icon-option" data-icon="üìû" title="Contato/CRM">üìû</div>
                    <div class="icon-option" data-icon="üè†" title="Unidade/Loja">üè†</div>
                </div>
                <input type="hidden" id="selectedIcon">

                <div class="upload-area" id="uploadArea">
                    <p>üìÑ Clique para selecionar o arquivo HTML</p>
                    <input type="file" id="htmlFileInput" accept=".html" style="display: none;" required>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary" id="submitBtn" disabled>Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2>üîê Senha do Admin</h2>
            <p style="margin-bottom: 15px; color: #666;">Digite a senha para atualizar a nuvem.</p>
            <input type="password" id="adminPasswordInput" class="form-control" placeholder="Senha...">
            <div class="form-actions">
                <button class="btn-secondary" onclick="closePasswordModal()">Cancelar</button>
                <button class="btn-primary" onclick="confirmAndUpload()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // CONFIGURA√á√ïES GLOBAIS
        const ADMIN_PASSWORD = "Recreio@01";
        const DB_NAME = 'HondaHubDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'systems';
        
        let db; // Vari√°vel do IndexedDB
        let firestoreDB; // Vari√°vel do Firestore

        // --- 1. INICIALIZA√á√ÉO DO FIREBASE (MODO COMPATIBILIDADE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB3Lq5nnCV-2caEhIXqny_S3wjX3DIh-5Q",
            authDomain: "hub-recreio.firebaseapp.com",
            projectId: "hub-recreio",
            storageBucket: "hub-recreio.firebasestorage.app",
            messagingSenderId: "633796172054",
            appId: "1:633796172054:web:545d2282cfdb9cc7315837"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            firestoreDB = firebase.firestore();
            console.log("Firebase conectado com sucesso!");
        } catch (error) {
            console.error("Erro ao conectar Firebase:", error);
            alert("Erro de conex√£o com a Nuvem. Verifique o console.");
        }

        // --- 2. FUN√á√ïES DE BANCO DE DADOS LOCAL (INDEXEDDB) ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => reject(e.target.error);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
            });
        }

        async function saveSystemToDB(system) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], "readwrite");
                const store = tx.objectStore(STORE_NAME);
                store.put(system).onsuccess = () => resolve();
                store.put(system).onerror = (e) => reject(e);
            });
        }

        async function getAllSystems() {
            return new Promise((resolve) => {
                if(!db) return resolve([]);
                const tx = db.transaction([STORE_NAME], "readonly");
                const req = tx.objectStore(STORE_NAME).getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve([]);
            });
        }

        async function deleteSystemFromDB(id) {
            return new Promise((resolve) => {
                const tx = db.transaction([STORE_NAME], "readwrite");
                tx.objectStore(STORE_NAME).delete(id).onsuccess = () => resolve();
            });
        }

        // --- 3. FUN√á√ïES DE NUVEM (USANDO FIRESTORE GLOBAL) ---
        
        // Bot√£o "Backup Nuvem"
        function openSyncModal() {
            document.getElementById('passwordModal').style.display = 'block';
            const input = document.getElementById('adminPasswordInput');
            input.value = '';
            input.focus();
            input.onkeypress = (e) => { if(e.key === 'Enter') confirmAndUpload(); };
        }

        // Enviar para nuvem
        async function confirmAndUpload() {
            const input = document.getElementById('adminPasswordInput').value;
            if (input !== ADMIN_PASSWORD) {
                alert("Senha incorreta!");
                return;
            }
            
            closePasswordModal();
            if(!confirm("Substituir o banco da nuvem pelos dados locais?")) return;

            showNotify("Enviando...", "info");
            
            try {
                const localData = await getAllSystems();
                if(localData.length === 0) {
                    showNotify("Nada para enviar.", "error");
                    return;
                }

                // Upload em Lote (Batch)
                const batch = firestoreDB.batch();
                localData.forEach(sys => {
                    const ref = firestoreDB.collection('sistemas').doc(sys.id);
                    batch.set(ref, sys);
                });

                await batch.commit();
                showNotify("‚úì Nuvem atualizada!", "success");
            } catch (e) {
                console.error(e);
                showNotify("Erro no upload. Veja o console.", "error");
            }
        }

        // Baixar da nuvem
        async function syncDownload() {
            if(!confirm("Baixar da nuvem? Isso substituir√° seus dados locais.")) return;
            
            showNotify("Baixando...", "info");
            try {
                const snapshot = await firestoreDB.collection('sistemas').get();
                if (snapshot.empty) {
                    showNotify("Nuvem vazia.", "error");
                    return;
                }

                const cloudData = snapshot.docs.map(doc => doc.data());
                
                // Salvar tudo localmente
                for(const sys of cloudData) {
                    await saveSystemToDB(sys);
                }
                
                renderSystems();
                showNotify("‚úì Restaurado com sucesso!", "success");
            } catch (e) {
                console.error(e);
                showNotify("Erro no download.", "error");
            }
        }

        // --- 4. L√ìGICA DE INTERFACE ---
        let uploadedHtmlContent = '';

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('homeView').style.display = 'block';
                renderSystems();
            } catch (e) {
                document.getElementById('loading').innerText = "Erro ao carregar DB.";
            }
            initEvents();
        });

        async function renderSystems() {
            const systems = await getAllSystems();
            const grid = document.getElementById('systemsGrid');
            grid.innerHTML = systems.map(sys => `
                <div class="system-card" onclick="loadSystem('${sys.id}')">
                    <div class="card-header">
                        <div class="card-icon">${sys.icon}</div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteSystem('${sys.id}')">Excluir</button>
                    </div>
                    <h3 class="card-title">${sys.name}</h3>
                    <p style="color:#666; font-size:0.9em">${sys.description}</p>
                </div>
            `).join('') || '<p style="grid-column:1/-1; text-align:center; color:#999;">Nenhum sistema encontrado.</p>';
        }

        async function handleAddSystem(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = "Salvando..."; btn.disabled = true;

            const newSystem = {
                id: 'sys_' + Date.now(),
                name: document.getElementById('systemName').value,
                description: document.getElementById('systemDescription').value,
                icon: document.getElementById('selectedIcon').value,
                content: uploadedHtmlContent,
                date: new Date().toISOString()
            };

            try {
                await saveSystemToDB(newSystem);
                // Tenta salvar na nuvem silenciosamente
                firestoreDB.collection('sistemas').doc(newSystem.id).set(newSystem).catch(e => console.log('Offline: Salvo apenas local'));
                
                showNotify("Sistema Salvo!");
                closeModal();
                renderSystems();
            } catch (err) {
                showNotify("Erro ao salvar.", "error");
            } finally {
                btn.innerHTML = "Salvar"; btn.disabled = false;
            }
        }

        async function deleteSystem(id) {
            if(confirm('Excluir este sistema?')) {
                await deleteSystemFromDB(id);
                // Opcional: Deletar da nuvem tamb√©m
                firestoreDB.collection('sistemas').doc(id).delete().catch(e => console.log('Erro ao deletar nuvem'));
                renderSystems();
                showNotify("Sistema removido.");
            }
        }

        // Fun√ß√µes Auxiliares (Modal, Fullscreen, etc)
        function closeModal() { document.getElementById('addSystemModal').style.display = 'none'; }
        function closePasswordModal() { document.getElementById('passwordModal').style.display = 'none'; }
        
        function showNotify(msg, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = msg;
            el.className = `notification show ${type}`;
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        async function loadSystem(id) {
            const systems = await getAllSystems();
            const sys = systems.find(s => s.id === id);
            if (!sys) return;

            document.getElementById('homeView').style.display = 'none';
            document.getElementById('systemView').style.display = 'block';
            document.getElementById('backBtn').style.display = 'flex';
            document.getElementById('addSystemBtn').style.display = 'none';
            document.querySelectorAll('.backup-btn').forEach(b => b.style.display = 'none');

            const blob = new Blob([sys.content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            document.getElementById('systemContent').innerHTML = `
                <div id="system-container-wrapper" style="height:100%; display:flex; flex-direction:column;">
                    <div class="system-header-controls" style="padding:10px 0; display:flex; justify-content:space-between; align-items:center;">
                        <h2 style="font-size:1.2em;">${sys.icon} ${sys.name}</h2>
                        <button id="fs-btn" onclick="toggleFullscreen()" style="padding:5px 10px; border:1px solid #ccc; border-radius:5px; background:white;">‚õ∂ Tela Cheia</button>
                    </div>
                    <iframe id="sys-iframe" src="${url}" style="flex:1; width:100%; border:none; background:white; border-radius:10px;"></iframe>
                </div>`;
        }

        function toggleFullscreen() {
            const container = document.getElementById('system-container-wrapper');
            const btn = document.getElementById('fs-btn');
            container.classList.toggle('fullscreen-mode');
            if(container.classList.contains('fullscreen-mode')) {
                btn.textContent = "‚úï Sair"; btn.style.background = "#fee2e2";
            } else {
                btn.textContent = "‚õ∂ Tela Cheia"; btn.style.background = "white";
            }
        }

        function initEvents() {
            document.getElementById('addSystemBtn').onclick = () => {
                document.getElementById('addSystemModal').style.display = 'block';
                document.getElementById('addSystemForm').reset();
                uploadedHtmlContent = '';
                document.getElementById('uploadArea').classList.remove('has-file');
            };
            document.getElementById('backBtn').onclick = () => {
                const c = document.getElementById('system-container-wrapper');
                if(c && c.classList.contains('fullscreen-mode')) toggleFullscreen();
                document.getElementById('homeView').style.display = 'block';
                document.getElementById('systemView').style.display = 'none';
                document.getElementById('backBtn').style.display = 'none';
                document.getElementById('addSystemBtn').style.display = 'block';
                document.querySelectorAll('.backup-btn').forEach(b => b.style.display = 'flex');
                document.getElementById('systemContent').innerHTML = '';
            };
            document.getElementById('addSystemForm').onsubmit = handleAddSystem;
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('htmlFileInput');
            uploadArea.onclick = () => fileInput.click();
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        uploadedHtmlContent = ev.target.result;
                        uploadArea.classList.add('has-file');
                        document.getElementById('submitBtn').disabled = false;
                    };
                    reader.readAsText(file);
                }
            };
            
            document.querySelectorAll('.icon-option').forEach(opt => {
                opt.onclick = () => {
                    document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('selectedIcon').value = opt.dataset.icon;
                };
            });
            
            window.onclick = (e) => {
                if(e.target == document.getElementById('addSystemModal')) closeModal();
                if(e.target == document.getElementById('passwordModal')) closePasswordModal();
            }
        }
        
        // Backup Local (JSON)
        async function exportData() {
            const data = await getAllSystems();
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "backup_recreio.json";
            a.click();
        }
        
        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    for(const s of data) await saveSystemToDB(s);
                    renderSystems();
                    showNotify("Importado com sucesso!");
                } catch(e) { showNotify("Erro no arquivo.", "error"); }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
