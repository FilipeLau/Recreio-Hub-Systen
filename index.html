<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integrado Honda - Recreio Motos</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#dc2626">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- ESTILOS VISUAIS (MANTIDOS) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 30%, #fff5f5 70%, #ffffff 100%);
            min-height: 100vh; overflow-x: hidden; position: relative;
        }

        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(circle at 20% 50%, rgba(220, 38, 38, 0.08) 0%, transparent 50%);
            pointer-events: none; z-index: -1;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(220, 38, 38, 0.15); padding: 15px 40px;
            position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .logo-section { display: flex; align-items: center; gap: 15px; }
        .logo-icon { width: 45px; height: 45px; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); border-radius: 12px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
        .logo-icon img { width: 120%; border-radius: 50%; }
        .brand-text h1 { color: #1a1a1a; font-size: 1.4em; font-weight: 700; background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-text p { color: #666; font-size: 0.8em; }

        .nav-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        button { cursor: pointer; border: none; font-family: inherit; }
        .action-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 13px; display: flex; gap: 6px; align-items: center; transition: 0.2s; }
        .backup-btn { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
        .backup-btn:hover { background: #e5e7eb; color: #1f2937; transform: translateY(-1px); }
        
        .add-system-btn { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); font-weight: 600; }
        .add-system-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3); }
        
        .back-btn { background: #dc2626; color: white; padding: 10px 20px; border-radius: 10px; display: none; font-weight: 600; }
        .back-btn:hover { background: #b91c1c; transform: translateY(-2px); }

        .main-content { max-width: 1400px; margin: 40px auto; padding: 0 40px; }
        .systems-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; }
        
        .system-card { background: white; border: 1px solid rgba(220, 38, 38, 0.1); border-radius: 20px; padding: 30px; transition: 0.3s; cursor: pointer; position: relative; overflow: hidden; }
        .system-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(220, 38, 38, 0.1); border-color: rgba(220, 38, 38, 0.3); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .card-icon { font-size: 40px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); }
        .delete-btn { background: #fee2e2; color: #dc2626; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 11px; opacity: 0; transition: 0.2s; }
        .system-card:hover .delete-btn { opacity: 1; }
        .card-title { font-size: 1.3em; font-weight: 700; color: #1f2937; margin-bottom: 8px; }

        .badge-online { position: absolute; top: 20px; right: 20px; background: #e0f2fe; color: #0284c7; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 4px; border: 1px solid #bae6fd; }

        .fullscreen-mode { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 5000; background: #f8f9fa; padding: 0 !important; margin: 0 !important; }
        .fullscreen-mode #sys-iframe { height: 100% !important; border: none !important; border-radius: 0 !important; }
        .fullscreen-mode .system-header-controls { position: absolute; top: 10px; right: 20px; z-index: 5001; background: rgba(255,255,255,0.95); padding: 8px 16px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.1); }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); animation: fadeIn 0.2s ease; }
        .modal-content { background: white; margin: 5vh auto; padding: 35px; border-radius: 24px; width: 90%; max-width: 650px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-height: 90vh; overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-family: inherit; transition: 0.3s; font-size: 15px; }
        .form-control:focus { border-color: #dc2626; outline: none; }

        .type-selector { display: flex; gap: 10px; margin-bottom: 25px; background: #f3f4f6; padding: 5px; border-radius: 12px; }
        .type-option { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 10px; font-weight: 600; color: #6b7280; transition: 0.3s; }
        .type-option.active { background: white; color: #dc2626; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        .icon-selector { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        .icon-option { width: 48px; height: 48px; display: flex; justify-content: center; align-items: center; border: 2px solid #f3f4f6; border-radius: 12px; cursor: pointer; font-size: 24px; transition: 0.2s; background: white; }
        .icon-option:hover { transform: scale(1.1); border-color: #fee2e2; }
        .icon-option.selected { border-color: #dc2626; background: #fef2f2; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15); }

        .upload-area { border: 2px dashed #e5e7eb; padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; transition: 0.3s; background: #f9fafb; }
        .upload-area:hover { border-color: #dc2626; background: #fef2f2; }
        .upload-area.has-file { border-color: #10b981; background: #ecfdf5; }
        .url-input-container { display: none; }

        .form-actions { display: flex; gap: 12px; margin-top: 30px; }
        .btn-primary { flex: 1; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 14px; border-radius: 12px; font-weight: 600; transition: 0.2s; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 166px rgba(220, 38, 38, 0.2); }
        .btn-primary:disabled { background: #e5e7eb; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { flex: 1; background: #f3f4f6; color: #374151; padding: 14px; border-radius: 12px; font-weight: 600; }
        .btn-secondary:hover { background: #e5e7eb; }

        .notification { position: fixed; bottom: 30px; right: 30px; padding: 16px 24px; background: #10b981; color: white; border-radius: 12px; transform: translateY(150px); transition: 0.3s; z-index: 6000; font-weight: 500; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .notification.show { transform: translateY(0); }
        .notification.error { background: #dc2626; }
        .notification.info { background: #2563eb; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo-section">
            <div class="logo-icon"><img src="https://logodownload.org/wp-content/uploads/2014/04/honda-motos-logo-01.png"></div>
            <div class="brand-text"><h1>Recreio Motos</h1><p>Sistema Integrado de Gest√£o</p></div>
        </div>
        <div class="nav-buttons">
            <button class="action-btn backup-btn" onclick="syncDownload()">‚òÅÔ∏è‚¨áÔ∏è Restaurar Nuvem</button>
            <button class="action-btn backup-btn" onclick="openSyncModal()">‚òÅÔ∏è‚¨ÜÔ∏è Backup Nuvem</button>
            <button class="action-btn backup-btn" onclick="exportData()">‚¨á Local</button>
            <button class="action-btn backup-btn" onclick="document.getElementById('importFile').click()">‚¨Ü Local</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
            
            <button class="add-system-btn" id="addSystemBtn">+ Adicionar</button>
            <button class="back-btn" id="backBtn">‚Üê Voltar</button>
        </div>
    </nav>

    <main class="main-content">
        <div id="loading" style="text-align:center; padding: 50px; color: #666;">Carregando biblioteca...</div>
        
        <div class="home-view" id="homeView" style="display:none">
            <div class="systems-grid" id="systemsGrid"></div>
        </div>

        <div class="system-view" id="systemView" style="display:none">
            <div id="systemContent" style="height: calc(100vh - 140px);"></div>
        </div>
    </main>

    <div id="addSystemModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; text-align: center; color: #1a1a1a;">Novo Sistema</h2>
            
            <form id="addSystemForm">
                <div class="type-selector">
                    <div class="type-option active" onclick="switchType('file')" id="typeFileBtn">üìÇ Arquivo Local</div>
                    <div class="type-option" onclick="switchType('link')" id="typeLinkBtn">üåê Link Online</div>
                </div>
                <input type="hidden" id="systemType" value="file">

                <div class="form-group">
                    <label>Nome do Sistema</label>
                    <input type="text" class="form-control" id="systemName" required placeholder="Ex: Portal Honda">
                </div>
                
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea class="form-control" id="systemDescription" required placeholder="Para que serve este sistema?"></textarea>
                </div>
                
                <div class="form-group">
                    <label>√çcone</label>
                    <div class="icon-selector" id="iconSelector">
                        <div class="icon-option" data-icon="üìä" title="Relat√≥rios">üìä</div>
                        <div class="icon-option" data-icon="üìà" title="Vendas">üìà</div>
                        <div class="icon-option" data-icon="üìã" title="Checklist">üìã</div>
                        <div class="icon-option" data-icon="üèçÔ∏è" title="Motos">üèçÔ∏è</div>
                        <div class="icon-option" data-icon="üîß" title="Oficina">üîß</div>
                        <div class="icon-option" data-icon="‚öôÔ∏è" title="Pe√ßas">‚öôÔ∏è</div>
                        <div class="icon-option" data-icon="üõû" title="Pneus">üõû</div>
                        <div class="icon-option" data-icon="üí∞" title="Financeiro">üí∞</div>
                        <div class="icon-option" data-icon="üí≥" title="Pagamentos">üí≥</div>
                        <div class="icon-option" data-icon="üè¶" title="Banco">üè¶</div>
                        <div class="icon-option" data-icon="üõ°Ô∏è" title="Seguros">üõ°Ô∏è</div>
                        <div class="icon-option" data-icon="üì¶" title="Estoque">üì¶</div>
                        <div class="icon-option" data-icon="üöö" title="Entrega">üöö</div>
                        <div class="icon-option" data-icon="üè≠" title="F√°brica">üè≠</div>
                        <div class="icon-option" data-icon="üë•" title="Clientes">üë•</div>
                        <div class="icon-option" data-icon="üìÖ" title="Agenda">üìÖ</div>
                        <div class="icon-option" data-icon="üìù" title="Contratos">üìù</div>
                        <div class="icon-option" data-icon="üìû" title="Contato">üìû</div>
                        <div class="icon-option" data-icon="üè¢" title="Filial">üè¢</div>
                        <div class="icon-option" data-icon="üåê" title="Web">üåê</div>
                    </div>
                    <input type="hidden" id="selectedIcon">
                </div>

                <div class="form-group" id="fileInputGroup">
                    <label>Arquivo HTML</label>
                    <div class="upload-area" id="uploadArea">
                        <div style="font-size: 30px; margin-bottom: 10px;">üìÑ</div>
                        <p>Clique para selecionar o arquivo .html</p>
                        <input type="file" id="htmlFileInput" accept=".html" style="display: none;">
                    </div>
                </div>

                <div class="form-group url-input-container" id="urlInputGroup">
                    <label>URL do Sistema (https://...)</label>
                    <input type="url" class="form-control" id="systemUrl" placeholder="https://www.honda.com.br/...">
                    <p style="font-size:12px; color:#666; margin-top:5px; background: #fffbeb; padding: 8px; border-radius: 6px; border: 1px solid #fcd34d;">‚ö†Ô∏è Sites como Google e Bancos podem bloquear a abertura dentro do Hub. Um bot√£o "Abrir Nova Aba" ser√° criado automaticamente.</p>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary" id="submitBtn" disabled>Salvar Sistema</button>
                </div>
            </form>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 40px; margin-bottom: 15px;">üîê</div>
            <h2 style="margin-bottom: 10px;">Senha do Admin</h2>
            <p style="margin-bottom: 20px; color: #666;">Digite a senha para atualizar o banco de dados global.</p>
            <input type="password" id="adminPasswordInput" class="form-control" placeholder="Senha..." style="text-align: center; font-size: 18px;">
            <div class="form-actions">
                <button class="btn-secondary" onclick="closePasswordModal()">Cancelar</button>
                <button class="btn-primary" onclick="confirmAndUpload()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // CONFIGURA√á√ïES GLOBAIS
        const ADMIN_PASSWORD = "Recreio@01";
        const DB_NAME = 'HondaHubDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'systems';
        
        let db; // IndexedDB
        let firestoreDB; // Firestore

        const firebaseConfig = {
            apiKey: "AIzaSyB3Lq5nnCV-2caEhIXqny_S3wjX3DIh-5Q",
            authDomain: "hub-recreio.firebaseapp.com",
            projectId: "hub-recreio",
            storageBucket: "hub-recreio.firebasestorage.app",
            messagingSenderId: "633796172054",
            appId: "1:633796172054:web:545d2282cfdb9cc7315837"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            firestoreDB = firebase.firestore();
            console.log("Firebase Online");
        } catch (error) {
            console.error("Erro Firebase:", error);
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => reject(e.target.error);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
            });
        }

        async function saveSystemToDB(system) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], "readwrite");
                const store = tx.objectStore(STORE_NAME);
                store.put(system).onsuccess = () => resolve();
                store.put(system).onerror = (e) => reject(e);
            });
        }

        async function getAllSystems() {
            return new Promise((resolve) => {
                if(!db) return resolve([]);
                const tx = db.transaction([STORE_NAME], "readonly");
                const req = tx.objectStore(STORE_NAME).getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve([]);
            });
        }

        async function deleteSystemFromDB(id) {
            return new Promise((resolve) => {
                const tx = db.transaction([STORE_NAME], "readwrite");
                tx.objectStore(STORE_NAME).delete(id).onsuccess = () => resolve();
            });
        }

        let uploadedHtmlContent = '';

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('homeView').style.display = 'block';
                renderSystems();
            } catch (e) {
                document.getElementById('loading').innerText = "Erro ao carregar DB Local.";
            }
            initEvents();
        });

        window.switchType = function(type) {
            document.getElementById('systemType').value = type;
            document.getElementById('typeFileBtn').className = type === 'file' ? 'type-option active' : 'type-option';
            document.getElementById('typeLinkBtn').className = type === 'link' ? 'type-option active' : 'type-option';
            
            if (type === 'file') {
                document.getElementById('fileInputGroup').style.display = 'block';
                document.getElementById('urlInputGroup').style.display = 'none';
                document.getElementById('systemUrl').required = false;
            } else {
                document.getElementById('fileInputGroup').style.display = 'none';
                document.getElementById('urlInputGroup').style.display = 'block';
                document.getElementById('systemUrl').required = true;
            }
            validateForm();
        }

        async function renderSystems() {
            const systems = await getAllSystems();
            const grid = document.getElementById('systemsGrid');
            
            grid.innerHTML = systems.map(sys => `
                <div class="system-card" onclick="loadSystem('${sys.id}')">
                    ${sys.type === 'link' ? '<div class="badge-online">üåê Online</div>' : ''}
                    <div class="card-header">
                        <div class="card-icon">${sys.icon}</div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteSystem('${sys.id}')">Excluir</button>
                    </div>
                    <h3 class="card-title">${sys.name}</h3>
                    <p style="color:#666; font-size:0.9em; line-height:1.4;">${sys.description}</p>
                </div>
            `).join('') || `
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:#999; border:2px dashed #eee; border-radius:20px;">
                    <div style="font-size:40px; margin-bottom:10px;">üìÇ</div>
                    <p>Nenhum sistema encontrado.</p>
                </div>`;
        }

        async function handleAddSystem(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = "Salvando..."; btn.disabled = true;

            const type = document.getElementById('systemType').value;
            const newSystem = {
                id: 'sys_' + Date.now(),
                name: document.getElementById('systemName').value,
                description: document.getElementById('systemDescription').value,
                icon: document.getElementById('selectedIcon').value,
                type: type,
                date: new Date().toISOString()
            };

            if (type === 'file') {
                newSystem.content = uploadedHtmlContent;
            } else {
                newSystem.url = document.getElementById('systemUrl').value;
                newSystem.content = null;
            }

            try {
                // CORRE√á√ÉO: Salva apenas no banco local (IndexedDB) - Removido save da nuvem
                await saveSystemToDB(newSystem);
                
                showNotify("Sistema Salvo Localmente!");
                closeModal();
                renderSystems();
            } catch (err) {
                showNotify("Erro ao salvar.", "error");
            } finally {
                btn.innerHTML = "Salvar Sistema"; btn.disabled = false;
            }
        }

        async function loadSystem(id) {
            const systems = await getAllSystems();
            const sys = systems.find(s => s.id === id);
            if (!sys) return;

            document.getElementById('homeView').style.display = 'none';
            document.getElementById('systemView').style.display = 'block';
            document.getElementById('backBtn').style.display = 'flex';
            document.getElementById('addSystemBtn').style.display = 'none';
            document.querySelectorAll('.backup-btn').forEach(b => b.style.display = 'none');

            let iframeSrc = '';
            let isExternal = false;

            if (sys.type === 'link') {
                iframeSrc = sys.url;
                isExternal = true;
            } else {
                const content = sys.content || '<h1>Erro: Conte√∫do vazio</h1>';
                const blob = new Blob([content], { type: 'text/html' });
                iframeSrc = URL.createObjectURL(blob);
            }

            const container = document.getElementById('systemContent');
            // CORRE√á√ÉO: Adicionado allow-downloads ao sandbox
            container.innerHTML = `
                <div id="system-container-wrapper" style="height:100%; display:flex; flex-direction:column;">
                    <div class="system-header-controls" style="padding:10px 0; display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <h2 style="font-size:1.2em; margin:0; display:flex; align-items:center; gap:8px;">${sys.icon} ${sys.name}</h2>
                            ${isExternal ? `<a href="${sys.url}" target="_blank" class="action-btn" style="text-decoration:none; color:#2563eb; background:#eff6ff; border:1px solid #bfdbfe; font-size:12px;">‚Üó Abrir Nova Aba</a>` : ''}
                        </div>
                        <button id="fs-btn" onclick="toggleFullscreen()" style="padding:8px 16px; border:1px solid #e5e7eb; border-radius:8px; background:white; font-weight:600; color:#374151;">‚õ∂ Tela Cheia</button>
                    </div>
                    <iframe id="sys-iframe" src="${iframeSrc}" style="flex:1; width:100%; border:none; background:white; border-radius:16px; box-shadow:0 4px 6px rgba(0,0,0,0.05);" sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-modals allow-downloads"></iframe>
                </div>`;
        }

        window.openSyncModal = function() {
            document.getElementById('passwordModal').style.display = 'block';
            const input = document.getElementById('adminPasswordInput');
            input.value = ''; input.focus();
            input.onkeypress = (e) => { if(e.key === 'Enter') confirmAndUpload(); };
        }

        // CORRE√á√ÉO: Fun√ß√£o de Backup agora limpa a nuvem e sincroniza
        window.confirmAndUpload = async function() {
            const input = document.getElementById('adminPasswordInput').value;
            if (input !== ADMIN_PASSWORD) { alert("Senha incorreta!"); return; }
            
            closePasswordModal();
            if(!confirm("Aten√ß√£o: Isso tornar√° a Nuvem id√™ntica a esta m√°quina. Itens que n√£o est√£o aqui ser√£o removidos da nuvem. Continuar?")) return;

            showNotify("Sincronizando nuvem...", "info");
            try {
                const localData = await getAllSystems();
                
                // 1. Pegar todos os documentos atuais da nuvem
                const snapshot = await firestoreDB.collection('sistemas').get();
                const batch = firestoreDB.batch();

                // 2. Adicionar opera√ß√£o para deletar cada documento existente na nuvem
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // 3. Adicionar opera√ß√£o para inserir os dados locais
                localData.forEach(sys => {
                    const ref = firestoreDB.collection('sistemas').doc(sys.id);
                    batch.set(ref, sys);
                });

                // 4. Executar tudo em um √∫nico processo
                await batch.commit();
                showNotify("‚úì Nuvem sincronizada com sucesso!", "success");
            } catch (e) {
                console.error(e);
                showNotify("Erro ao sincronizar.", "error");
            }
        }

        window.syncDownload = async function() {
            if(!confirm("Baixar da nuvem? Isso substituir√° seus dados locais.")) return;
            showNotify("Baixando...", "info");
            try {
                const snapshot = await firestoreDB.collection('sistemas').get();
                if (snapshot.empty) { showNotify("Nuvem vazia.", "error"); return; }

                const cloudData = snapshot.docs.map(doc => doc.data());
                for(const sys of cloudData) await saveSystemToDB(sys);
                
                renderSystems();
                showNotify("‚úì Restaurado!");
            } catch (e) {
                showNotify("Erro no download.", "error");
            }
        }

        async function deleteSystem(id) {
            if(confirm('Excluir sistema desta m√°quina? (Para excluir da nuvem, fa√ßa o Backup ap√≥s esta a√ß√£o)')) {
                // CORRE√á√ÉO: Remove apenas localmente
                await deleteSystemFromDB(id);
                renderSystems();
                showNotify("Removido localmente.");
            }
        }

        window.toggleFullscreen = function() {
            const container = document.getElementById('system-container-wrapper');
            const btn = document.getElementById('fs-btn');
            container.classList.toggle('fullscreen-mode');
            if(container.classList.contains('fullscreen-mode')) {
                btn.textContent = "‚úï Sair"; btn.style.background = "#fee2e2"; btn.style.color = "#dc2626"; btn.style.borderColor = "#fecaca";
            } else {
                btn.textContent = "‚õ∂ Tela Cheia"; btn.style.background = "white"; btn.style.color = "#374151"; btn.style.borderColor = "#e5e7eb";
            }
        }

        window.closeModal = function() { document.getElementById('addSystemModal').style.display = 'none'; }
        window.closePasswordModal = function() { document.getElementById('passwordModal').style.display = 'none'; }
        
        function showNotify(msg, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = msg;
            el.className = `notification show ${type}`;
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function validateForm() {
            const name = document.getElementById('systemName').value;
            const icon = document.getElementById('selectedIcon').value;
            const type = document.getElementById('systemType').value;
            let valid = false;
            
            if(type === 'file') valid = (uploadedHtmlContent !== '');
            else valid = (document.getElementById('systemUrl').value.startsWith('http'));

            document.getElementById('submitBtn').disabled = !(name && icon && valid);
        }

        function initEvents() {
            document.getElementById('addSystemBtn').onclick = () => {
                document.getElementById('addSystemModal').style.display = 'block';
                document.getElementById('addSystemForm').reset();
                uploadedHtmlContent = '';
                document.getElementById('uploadArea').classList.remove('has-file');
                switchType('file');
            };

            document.getElementById('backBtn').onclick = () => {
                const c = document.getElementById('system-container-wrapper');
                if(c && c.classList.contains('fullscreen-mode')) toggleFullscreen();
                document.getElementById('homeView').style.display = 'block';
                document.getElementById('systemView').style.display = 'none';
                document.getElementById('backBtn').style.display = 'none';
                document.getElementById('addSystemBtn').style.display = 'block';
                document.querySelectorAll('.backup-btn').forEach(b => b.style.display = 'flex');
                document.getElementById('systemContent').innerHTML = '';
            };

            document.getElementById('uploadArea').onclick = () => document.getElementById('htmlFileInput').click();
            document.getElementById('htmlFileInput').onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        uploadedHtmlContent = ev.target.result;
                        document.getElementById('uploadArea').classList.add('has-file');
                        validateForm();
                    };
                    reader.readAsText(file);
                }
            };

            document.getElementById('systemName').oninput = validateForm;
            document.getElementById('systemUrl').oninput = validateForm;
            document.getElementById('addSystemForm').onsubmit = handleAddSystem;

            document.querySelectorAll('.icon-option').forEach(opt => {
                opt.onclick = () => {
                    document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('selectedIcon').value = opt.dataset.icon;
                    validateForm();
                };
            });

            window.onclick = (e) => {
                if(e.target == document.getElementById('addSystemModal')) closeModal();
                if(e.target == document.getElementById('passwordModal')) closePasswordModal();
            }
        }

        window.exportData = async function() {
            const data = await getAllSystems();
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "backup_recreio.json";
            a.click();
        }
        
        window.importData = function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    for(const s of data) await saveSystemToDB(s);
                    renderSystems();
                    showNotify("Importado!");
                } catch(e) { showNotify("Erro no arquivo.", "error"); }
            };
            reader.readAsText(file);
            input.value = '';
        }
    </script>
</body>
</html>
